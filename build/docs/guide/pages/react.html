<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
                      "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
    <title>3.13 React</title>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
    <link rel="stylesheet" href="../css/main.css" type="text/css" media="screen, print" title="Style" charset="utf-8"/>
    <link rel="stylesheet" href="../css/guide.css" type="text/css" media="screen, print" title="Style" charset="utf-8" />            
    <link rel="stylesheet" href="../css/pdf.css" type="text/css" media="print" title="PDF" charset="utf-8"/>
    <script type="text/javascript">
function addJsClass() {
    var classes = document.body.className.split(" ");
    classes.push("js");
    document.body.className = classes.join(" ");
}
    </script>
</head>

<body class="body" onload="addJsClass();">
<div id="navigation">
    <div class="navTitle">
        
        Grails Framework Guide 
    </div>
    <div class="navLinks">
        <ul>
            <li>
                <div id="nav-summary" onmouseover="toggleNavSummary(false)" onmouseout="toggleNavSummary(true)">
                    <a href="../../guide/index.html" class="button">Table of contents</a>

                    <div id="nav-summary-childs" style="display:none;">
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/gettingStarted.html"><strong>1</strong><span>Introduction</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/requirements.html"><strong>2</strong><span>Requirements</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/writingTheApp.html"><strong>3</strong><span>Writing the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/runningTheApp.html"><strong>4</strong><span>Running the Application</span></a>
                        </div>
                        
                        <div class="toc-item" style="margin-left:0"><a href="../../guide/helpWithGrails.html"><strong>5</strong><span>Help with Grails</span></a>
                        </div>
                        
                    </div>
                </div>
            </li>
        </ul>
    </div>


</div>

<table id="colset" border="0" cellpadding="0" cellspacing="0">
    <tr>
        <td id="col1">
            <div id="main" class="corner-all">

                
                    <div class="toc-item prev-left"><a href="../../guide/requirements.html">&lt;&lt; <strong>2</strong><span>Requirements</span></a></div>
                

                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>4</strong><span>Running the Application</span> >></a></div>
                


                

                

<h2 id="react">3.13 React</h2>

<div class='contribute-btn'>
    <button type='button' class='btn btn-default' onclick='window.location.href="https://github.com/grails-guides/grails-vs-nodejs/edit/master/src/main/docs/guide/react.adoc"'>
        <i class='fa fa-pencil-square-o'></i> Improve this doc
    </button>
</div>


<div class="paragraph">
<p>Now we’re ready to turn to the client-side portion of our app. For this
step, we are going to be using the code found in the Github repo for the
<a href="https://objectcomputing.com/resources/publications/sett/april-2017-web-app-step-by-step">previous “Web App” article</a>. You can access the code here:
<a href="https://github.com/mvolkmann/ice-cream-app/tree/master/src" class="bare">https://github.com/mvolkmann/ice-cream-app/tree/master/src</a></p>
</div>
<div class="paragraph">
<p>Download (or <code>git clone</code>) the source files at the URL above, and copy
them into the <code>client/src</code> directory (overwriting any existing files).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">~ cd ../
~ git clone https://github.com/mvolkmann/ice-cream-app tmp
~ cp -Rv tmp/* ice-cream/client/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will make the <code>client</code> subproject identical to the Ice Cream app
from the <a href="https://objectcomputing.com/resources/publications/sett/april-2017-web-app-step-by-step">previous article</a>.</p>
</div>
<div class="paragraph">
<p>Now, let’s delete the files we don’t need.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">~ cd ice-cream/client
~ rm -rf database/ server/ css/ images/</code></pre>
</div>
</div>
<div class="paragraph">
<p>This should leave you with the following directories under <code>client</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-rw-r--r--  LICENSE
-rw-r--r--  README.md
drwxr-xr-x  build
-rw-r--r--  build.gradle
drwxr-xr-x  node_modules
-rw-r--r--  package.json
drwxr-xr-x  public
drwxr-xr-x  src
-rw-r--r--  yarn.lock</code></pre>
</div>
</div>
<div class="paragraph">
<p>And the following files under <code>client/src</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">-rw-r--r--  App.css
-rw-r--r--  App.js
-rw-r--r--  App.test.js
-rw-r--r--  config.js
-rw-r--r--  ice-cream-entry.js
-rw-r--r--  ice-cream-list.js
-rw-r--r--  ice-cream-row.js
-rw-r--r--  index.css
-rw-r--r--  index.js
-rw-r--r--  login.js
-rw-r--r--  main.js</code></pre>
</div>
</div>
<div class="paragraph">
<p>We only have to edit 2 of these <code>src</code> files, and update our
<code>package.json</code>, in order to hook up the React app with our new Grails
backend.</p>
</div>
<div class="paragraph">
<p>First, edit <code>client/package.json</code> as shown below:</p>
</div>
<div class="listingblock">
<div class="title">/client/package.json</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript">{
  <span class="key"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">ice-cream-app</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">version</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0.1.0</span><span class="delimiter">&quot;</span></span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">private</span><span class="delimiter">&quot;</span></span>: <span class="predefined-constant">true</span>,
  <span class="key"><span class="delimiter">&quot;</span><span class="content">devDependencies</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">eslint</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^3.17.1</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">eslint-plugin-flowtype</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.30.3</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">eslint-plugin-react</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^6.10.0</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">react-scripts</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">0.8.4</span><span class="delimiter">&quot;</span></span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">dependencies</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">react</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^15.4.2</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">react-dom</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^15.4.2</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">sockjs-client</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^1.1.4</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">stompjs</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">^2.3.3</span><span class="delimiter">&quot;</span></span>
  },
  <span class="key"><span class="delimiter">&quot;</span><span class="content">scripts</span><span class="delimiter">&quot;</span></span>: {
    <span class="key"><span class="delimiter">&quot;</span><span class="content">build</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">react-scripts build</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">coverage</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">npm test -- --coverage</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">lint</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">eslint src/**/*.js server/**/*.js</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">start</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">react-scripts start</span><span class="delimiter">&quot;</span></span>,
    <span class="key"><span class="delimiter">&quot;</span><span class="content">test</span><span class="delimiter">&quot;</span></span>: <span class="string"><span class="delimiter">&quot;</span><span class="content">react-scripts test --env=jsdom</span><span class="delimiter">&quot;</span></span>
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We’ve removed several packages that were needed by the Node Express
server, and we’ve replaced the <code>socket.io</code> package with <code>sockjs-client</code>
and <code>stompjs</code>, which is supported by the Spring Websockets library we’ve
configured previously (<code>socket.io</code> is designed for Node apps and is not
compatible with Spring Websockets).</p>
</div>
<div class="paragraph">
<p>We also need to edit the <code>config.js</code> file. This is provided by the React
profile for Grails and simply holds a few config variables, including a
<code>SERVER_URL</code> value which sets the API base URL. Edit the file as shown
below:</p>
</div>
<div class="listingblock">
<div class="title">/client/src/config.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> pjson from <span class="string"><span class="delimiter">'</span><span class="content">./../package.json</span><span class="delimiter">'</span></span>;

<span class="reserved">export</span> const SERVER_URL = <span class="string"><span class="delimiter">'</span><span class="content">http://localhost:8080</span><span class="delimiter">'</span></span>;
<span class="reserved">export</span> const CLIENT_VERSION = pjson.version;
<span class="reserved">export</span> const REACT_VERSION = pjson.dependencies.react;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we have to update two of the React components in our Ice Cream app,
<code>Login</code> and <code>App</code>.</p>
</div>
<div class="paragraph">
<p>Edit the <code>login.js</code> file as shown below (changes from the <a href="https://objectcomputing.com/resources/publications/sett/april-2017-web-app-step-by-step">original
code</a> are marked with <code>//NEW:</code> comments).</p>
</div>
<div class="listingblock">
<div class="title">/client/src/login.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> React, {Component, PropTypes as t} from <span class="string"><span class="delimiter">'</span><span class="content">react</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> <span class="string"><span class="delimiter">'</span><span class="content">whatwg-fetch</span><span class="delimiter">'</span></span>;

<span class="keyword">function</span> <span class="function">onChangePassword</span>(event) {
  React.setState({<span class="key">password</span>: event.target.value});
}

<span class="keyword">function</span> <span class="function">onChangeUsername</span>(event) {
  React.setState({<span class="key">username</span>: event.target.value});
}

<span class="reserved">class</span> Login <span class="reserved">extends</span> Component {
  <span class="reserved">static</span> propTypes = {
    <span class="key">password</span>: t.string.isRequired,
    <span class="key">restUrl</span>: t.string.isRequired,
    <span class="key">username</span>: t.string.isRequired,
    <span class="key">timeoutHandler</span>: t.func <span class="comment">//NEW: propType for our timeoutHander function</span>
  };

  <span class="comment">// This is called when the &quot;Log In&quot; button is pressed.</span>
  onLogin = async () =&gt; {
    const {password, restUrl, username, timeoutHandler} = <span class="local-variable">this</span>.props;
    const url = <span class="error">`</span><span class="predefined">$</span>{restUrl}/login<span class="error">`</span>;

    <span class="keyword">try</span> {
      <span class="comment">// Send username and password to login REST service.</span>
      const res = await fetch(url, {
        <span class="key">method</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>,
        <span class="key">headers</span>: {<span class="key"><span class="delimiter">'</span><span class="content">Content-Type</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>},
        <span class="key">body</span>: JSON.stringify({username, password})
      });

      <span class="keyword">if</span> (res.ok) { <span class="comment">// successful login</span>
        const text = await res.text(); <span class="comment">// returns a promise</span>

        <span class="comment">//NEW: Spring Security REST returns the token in the response body, not the Authorization header</span>
        const token = <span class="error">`</span>Bearer <span class="predefined">$</span>{JSON.parse(text).access_token}<span class="error">`</span>;

        React.setState({
          <span class="key">authenticated</span>: <span class="predefined-constant">true</span>,
          <span class="key">error</span>: <span class="predefined-constant">null</span>, <span class="comment">// clear previous error</span>
          <span class="key">route</span>: <span class="string"><span class="delimiter">'</span><span class="content">main</span><span class="delimiter">'</span></span>,
          token
        });

        timeoutHandler(username) <span class="comment">//NEW: Connects to a user-specific websocket channel</span>

      } <span class="keyword">else</span> { <span class="comment">//NEW: Any error response from the server indicates a failed login</span>
        const msg = <span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid username or password</span><span class="delimiter">&quot;</span></span>;
        React.setState({<span class="key">error</span>: msg});
      }
    } <span class="keyword">catch</span> (e) {
      React.setState({<span class="key">error</span>: <span class="error">`</span><span class="predefined">$</span>{url}; <span class="predefined">$</span>{e.message}<span class="error">`</span>});
    }
  }

  <span class="comment">// This is called when the &quot;Signup&quot; button is pressed.</span>
  onSignup = async () =&gt; {
    const {password, restUrl, username, timeoutHandler} = <span class="local-variable">this</span>.props;
    const url = <span class="error">`</span><span class="predefined">$</span>{restUrl}/signup<span class="error">`</span>;

    <span class="keyword">try</span> {
      const res = await fetch(url, {
        <span class="key">method</span>: <span class="string"><span class="delimiter">'</span><span class="content">POST</span><span class="delimiter">'</span></span>,
        <span class="key">headers</span>: {<span class="key"><span class="delimiter">'</span><span class="content">Content-Type</span><span class="delimiter">'</span></span>: <span class="string"><span class="delimiter">'</span><span class="content">application/json</span><span class="delimiter">'</span></span>},
        <span class="key">body</span>: JSON.stringify({username, password})
      });

      <span class="keyword">if</span> (res.ok) { <span class="comment">// successful signup</span>
        const text = await res.text(); <span class="comment">// returns a promise</span>
        const token = <span class="error">`</span>Bearer <span class="predefined">$</span>{JSON.parse(text).access_token}<span class="error">`</span>; <span class="comment">//NEW: See above</span>

        React.setState({
          <span class="key">authenticated</span>: <span class="predefined-constant">true</span>,
          <span class="key">error</span>: <span class="predefined-constant">null</span>, <span class="comment">// clear previous error</span>
          <span class="key">route</span>: <span class="string"><span class="delimiter">'</span><span class="content">main</span><span class="delimiter">'</span></span>,
          token
        });

        timeoutHandler(username) <span class="comment">//NEW: Connect to user-specific websocket channel</span>


      } <span class="keyword">else</span> { <span class="comment">// unsuccessful signup</span>
        let text = await res.text(); <span class="comment">// returns a promise</span>
        <span class="keyword">if</span> (<span class="regexp"><span class="delimiter">/</span><span class="content">duplicate key</span><span class="delimiter">/</span></span>.test(text)) {
          text = <span class="error">`</span>User <span class="predefined">$</span>{username} already exists<span class="error">`</span>;
        }
        React.setState({<span class="key">error</span>: text});
      }
    } <span class="keyword">catch</span> (e) {
      React.setState({<span class="key">error</span>: <span class="error">`</span><span class="predefined">$</span>{url}; <span class="predefined">$</span>{e.message}<span class="error">`</span>});
    }
  };

  render() {
    const {password, username} = <span class="local-variable">this</span>.props;
    const canSubmit = username &amp;&amp; password;

    <span class="comment">// We are handling sending the username and password</span>
    <span class="comment">// to a REST service above, so we don't want</span>
    <span class="comment">// the HTML form to submit anything for us.</span>
    <span class="comment">// That is the reason for the call to preventDefault.</span>
    <span class="keyword">return</span> (
      <span class="tag">&lt;form</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">login-form</span><span class="delimiter">&quot;</span></span>
            <span class="attribute-name">onSubmit</span>=<span class="error">{</span><span class="attribute-value">event</span> <span class="error">=</span><span class="tag">&gt;</span> event.preventDefault()}<span class="error">&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;label&gt;</span>Username:<span class="tag">&lt;/label&gt;</span>
          <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">text</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">autoFocus</span>
                 <span class="attribute-name">onChange</span>=<span class="error">{</span><span class="attribute-value">onChangeUsername</span><span class="error">}</span>
                 <span class="attribute-name">value</span>=<span class="error">{</span><span class="attribute-value">username</span><span class="error">}</span>
          <span class="tag">/&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          <span class="tag">&lt;label&gt;</span>Password:<span class="tag">&lt;/label&gt;</span>
          <span class="tag">&lt;input</span> <span class="attribute-name">type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">password</span><span class="delimiter">&quot;</span></span>
                 <span class="attribute-name">onChange</span>=<span class="error">{</span><span class="attribute-value">onChangePassword</span><span class="error">}</span>
                 <span class="attribute-name">value</span>=<span class="error">{</span><span class="attribute-value">password</span><span class="error">}</span>
          <span class="tag">/&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">row submit</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          {/* Pressing enter in either input invokes the first button. */}
          <span class="tag">&lt;button</span> <span class="attribute-name">disabled</span>=<span class="error">{</span><span class="error">!</span><span class="attribute-value">canSubmit</span><span class="error">}</span> <span class="attribute-name">onClick</span>=<span class="error">{</span><span class="attribute-value">this.onLogin</span><span class="error">}</span><span class="tag">&gt;</span>
            Log In
          <span class="tag">&lt;/button&gt;</span>
          <span class="tag">&lt;button</span> <span class="attribute-name">disabled</span>=<span class="error">{</span><span class="error">!</span><span class="attribute-value">canSubmit</span><span class="error">}</span> <span class="attribute-name">onClick</span>=<span class="error">{</span><span class="attribute-value">this.onSignup</span><span class="error">}</span><span class="tag">&gt;</span>
            Signup
          <span class="tag">&lt;/button&gt;</span>
        <span class="tag">&lt;/div&gt;</span>
      <span class="tag">&lt;/form&gt;</span>
    );
  }
}

<span class="reserved">export</span> <span class="keyword">default</span> Login;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, we can edit the <code>App.js</code> file to support our new websocket
channels, as well as our <code>SERVER_URL</code> config setting. Like above, all
changes relative to the <a href="https://objectcomputing.com/resources/publications/sett/april-2017-web-app-step-by-step">original code</a> are marked with <code>NEW</code> comments.</p>
</div>
<div class="listingblock">
<div class="title">/client/src/App.js</div>
<div class="content">
<pre class="CodeRay highlight"><code data-lang="javascript"><span class="reserved">import</span> React, {Component} from <span class="string"><span class="delimiter">'</span><span class="content">react</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> Login from <span class="string"><span class="delimiter">'</span><span class="content">./login</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> Main from <span class="string"><span class="delimiter">'</span><span class="content">./main</span><span class="delimiter">'</span></span>;
<span class="reserved">import</span> <span class="string"><span class="delimiter">'</span><span class="content">whatwg-fetch</span><span class="delimiter">'</span></span>; <span class="comment">// for REST calls</span>
<span class="reserved">import</span> {SERVER_URL} from <span class="string"><span class="delimiter">'</span><span class="content">./config</span><span class="delimiter">'</span></span>; <span class="comment">//NEW: Base url for REST calls</span>
<span class="reserved">import</span> <span class="string"><span class="delimiter">'</span><span class="content">./App.css</span><span class="delimiter">'</span></span>;

<span class="comment">// This allows the client to listen to sockJS events</span>
<span class="comment">// emitted from the server.  It is used to proactively</span>
<span class="comment">// terminate sessions when the session timeout expires.</span>
<span class="reserved">import</span> SockJS from <span class="string"><span class="delimiter">'</span><span class="content">sockjs-client</span><span class="delimiter">'</span></span>; <span class="comment">//NEW: SockJS &amp; Stomp instead of socket.io</span>
<span class="reserved">import</span> Stomp from <span class="string"><span class="delimiter">'</span><span class="content">stompjs</span><span class="delimiter">'</span></span>;

<span class="reserved">class</span> App <span class="reserved">extends</span> Component {
  constructor() {
    <span class="reserved">super</span>();

    <span class="comment">// Redux is a popular library for managing state in a React application.</span>
    <span class="comment">// This application, being somewhat small, opts for a simpler approach</span>
    <span class="comment">// where the top-most component manages all of the state.</span>
    <span class="comment">// Placing a bound version of the setState method on the React object</span>
    <span class="comment">// allows other components to call it in order to modify state.</span>
    <span class="comment">// Each call causes the UI to re-render,</span>
    <span class="comment">// using the &quot;Virtual DOM&quot; to make this efficient.</span>
    React.setState = <span class="local-variable">this</span>.setState.bind(<span class="local-variable">this</span>);
  }

  <span class="comment">//NEW: Remove the top-level websocket config in favor of user-specific channels (set on login)</span>

  <span class="comment">// This is the initial state of the application.</span>
  state = {
    <span class="key">authenticated</span>: <span class="predefined-constant">false</span>,
    <span class="key">error</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,
    <span class="key">flavor</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,
    <span class="key">iceCreamMap</span>: {},
    <span class="key">password</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,
    <span class="key">restUrl</span>: SERVER_URL, <span class="comment">//NEW: Use our SERVER_URL variable</span>
    <span class="key">route</span>: <span class="string"><span class="delimiter">'</span><span class="content">login</span><span class="delimiter">'</span></span>, <span class="comment">// controls the current page</span>
    <span class="key">token</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,
    <span class="key">username</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
  };

  <span class="comment">/**
   * NEW: Clears the token and redirects to the login page.
   * No logout API call is needed because JWT tokens
   * expire w/o state changes on the server */</span>
  logout = async () =&gt; {
      React.setState({
        <span class="key">authenticated</span>: <span class="predefined-constant">false</span>,
        <span class="key">route</span>: <span class="string"><span class="delimiter">'</span><span class="content">login</span><span class="delimiter">'</span></span>,
        <span class="key">password</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>,
        <span class="key">username</span>: <span class="string"><span class="delimiter">'</span><span class="delimiter">'</span></span>
      });
  };

  <span class="comment">/**
  * NEW: This function will be passed into the Login component as a prop
  * This gets a SockJS connection from the server
  * and subscribes to a &quot;topic/[username]&quot; channel for timeout events.
  * If one is received, the user is logged out. */</span>
  timeoutHandler = (username) =&gt; {
    const socket = <span class="keyword">new</span> SockJS(<span class="error">`</span><span class="predefined">$</span>{SERVER_URL}/stomp<span class="error">`</span>);
    const client = Stomp.over(socket);

    client.connect({}, () =&gt; {
      client.subscribe(<span class="error">`</span><span class="regexp"><span class="delimiter">/</span><span class="content">topic</span><span class="delimiter">/</span></span><span class="predefined">$</span>{username}<span class="error">`</span>, () =&gt; {
        alert(<span class="string"><span class="delimiter">'</span><span class="content">Your session timed out.</span><span class="delimiter">'</span></span>);
        <span class="local-variable">this</span>.logout();
      });
    }, () =&gt; {
      console.error(<span class="string"><span class="delimiter">'</span><span class="content">unable to connect</span><span class="delimiter">'</span></span>);
    });
  };

  render() {
    <span class="comment">// Use destructuring to extract data from the state object.</span>
    const {
      authenticated, error, flavor, iceCreamMap,
      password, restUrl, route, token, username
    } = <span class="local-variable">this</span>.state;

    <span class="keyword">return</span> (
      <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">App</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;header&gt;</span>
          <span class="tag">&lt;img</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">header-img</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">src</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ice-cream.png</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">alt</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">ice cream</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
          Ice cream, we all scream for it!
          {
            authenticated ?
              <span class="tag">&lt;button</span> <span class="attribute-name">onClick</span>=<span class="error">{</span><span class="attribute-value">this.logout</span><span class="error">}</span><span class="tag">&gt;</span>Log out<span class="tag">&lt;/button&gt;</span> :
              null
          }
        <span class="tag">&lt;/header&gt;</span>
        <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">App-body</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
          {
            // This is an alternative to controlling routing to pages
            // that is far simpler than more full-blown solutions
            // like react-router.
            route === 'login' ?
              <span class="tag">&lt;Login</span>
                <span class="attribute-name">username</span>=<span class="error">{</span><span class="attribute-value">username</span><span class="error">}</span>
                <span class="attribute-name">password</span>=<span class="error">{</span><span class="attribute-value">password</span><span class="error">}</span>
                <span class="attribute-name">restUrl</span>=<span class="error">{</span><span class="attribute-value">restUrl</span><span class="error">}</span>
                <span class="attribute-name">timeoutHandler</span>=<span class="error">{</span><span class="attribute-value">this.timeoutHandler</span><span class="error">}</span> <span class="error">/</span><span class="error">/</span><span class="attribute-name">NEW:</span> <span class="attribute-name">Pass</span> <span class="attribute-name">our</span> <span class="attribute-name">timeoutHandler</span> <span class="attribute-name">as</span> <span class="attribute-name">a</span> <span class="attribute-name">prop</span> <span class="attribute-name">to</span> <span class="error">&lt;</span><span class="attribute-name">Login</span><span class="tag">&gt;</span>
              /<span class="error">&gt;</span> :
            route === 'main' ?
              <span class="tag">&lt;Main</span>
                <span class="attribute-name">flavor</span>=<span class="error">{</span><span class="attribute-value">flavor</span><span class="error">}</span>
                <span class="attribute-name">iceCreamMap</span>=<span class="error">{</span><span class="attribute-value">iceCreamMap</span><span class="error">}</span>
                <span class="attribute-name">restUrl</span>=<span class="error">{</span><span class="attribute-value">restUrl</span><span class="error">}</span>
                <span class="attribute-name">token</span>=<span class="error">{</span><span class="attribute-value">token</span><span class="error">}</span>
                <span class="attribute-name">username</span>=<span class="error">{</span><span class="attribute-value">username</span><span class="error">}</span>
              <span class="tag">/&gt;</span> :
              <span class="tag">&lt;div&gt;</span>Unknown route {route}<span class="tag">&lt;/div&gt;</span>
          }
          {
            <span class="comment">// If an error has occurred, render it at the bottom of any page.</span>
            error ? <span class="tag">&lt;div</span> <span class="attribute-name">className</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">error</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>{error}<span class="tag">&lt;/div&gt;</span> : <span class="predefined-constant">null</span>
          }
        &lt;<span class="regexp"><span class="delimiter">/</span><span class="content">div&gt;
      &lt;</span><span class="delimiter">/</span></span>div&gt;
    );
  }
}

<span class="reserved">export</span> <span class="keyword">default</span> App;</code></pre>
</div>
</div>


                <div style="clear:both;margin-top:15px;"></div>
                
                    <div class="toc-item prev-left"><a href="../../guide/requirements.html">&lt;&lt; <strong>2</strong><span>Requirements</span></a></div>
                
                    <div class="toc-item next-right"><a href="../../guide/runningTheApp.html"><strong>4</strong><span>Running the Application</span> >></a></div>
                
                <div style="clear:both"></div>
            </div>
        </td>
        <td id="col2">
            <div class="local clearfix">
                <div class="local-title" style="text-align: right"><a href="https://travis-ci.org/grails-guides/grails-vs-nodejs"><img src="https://travis-ci.org/grails-guides/grails-vs-nodejs.svg?branch=master" /></a></div>            
                 <div class="local-title">
                    <a href="https://github.com/grails-guides/grails-vs-nodejs">
                    <svg height="35" class="octicon octicon-mark-github" viewBox="0 0 16 16" version="1.1" width="35" aria-hidden="true"><path fill-rule="evenodd" d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.013 8.013 0 0 0 16 8c0-4.42-3.58-8-8-8z"/></svg></a> &nbsp;&nbsp;Get the Code
                </div>
                <div class="menu">
                    <div class="input-group">                        
                        <button href="#" onclick="document.getElementById('github-url').value='git@github.com:grails-guides/grails-vs-nodejs.git'" class="codeButton">SSH</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-vs-nodejs.git'" class="codeButton">HTTPS</button>
                        <button onclick="document.getElementById('github-url').value='https://github.com/grails-guides/grails-vs-nodejs'" class="codeButton">Subversion</button>
                    </div>
       
                    <div class="input-group">                    
                        <!-- Target -->
                        <input id="github-url" value="git@github.com:grails-guides/grails-vs-nodejs.git" type="text" />

                        <!-- Trigger -->
                        <button class="clipbtn" type="button" data-clipboard-target="#github-url">

                            <img width="13" src="../img/clippy.svg" alt="Copy to clipboard">
                        </button>       

                    </div>
                    <div class="input-group">
                      <a href="https://github.com/grails-guides/grails-vs-nodejs/archive/master.zip" class="downloadButton">Download ZIP</a>
                    </div>
                </div>
            </div>
        </td>
    </tr>
</table>

<div id="footer">
    Copies of this document may be made for your own use and for distribution to others, provided that you do not charge any fee for such copies and further provided that each copy contains this Copyright Notice, whether distributed in print or electronically. All guides are released with an ASLv2 license for the code, and Creative Commons license for the writing. 
    
</div>

<script type="text/javascript" src="../js/docs.js"></script>

</body>
</html>
